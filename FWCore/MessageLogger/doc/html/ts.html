<title>
Thread Safe Error Logger 
</title>
<body bgcolor=FFFFFFFF>
<center>
<h1>ZOOM <img src="http://www.fnal.gov/docs/working-groups/fpcltf/icons/
particle_coll_bar_463_grey.gif" align="center"> ZOOM</h1>
</center>
<p>
<center>
<h1>
The ZOOM ErrorLogger Package:
<p>
<font color=red>
ThreadSafeErrorLog
</font>
</h1>
</center>
<p>

<h2> The General Idea </h2>

<h3> The Need </h3>

The program has initiated multiple threads (probably pthreads but this is 
irrelevant) which share the same address space for global variables.
Each thread may on 
occasion issue error messages using the ZOOM <b> ErrorLogger </b> package.
<p>
Using the naive ErrorLog mechanism, two threads issuing error messages at
overlapping times will each send instructions to the same ELadministrator.
This leads to the possibility of garbled messages.  
Instead, what is wanted is some way for each thread to independently compose a 
message, and each message to emerge as one uninterrupted chunk on the 
destinations.

<h3> Meeting this Need </h3>

The package now provides a new class <b>ThreadSafeErrorLog</b> derived from 
<b>ErrorLog</b>.  If each thread instantiates and uses its own instance of 
<b>ThreadSafeErrorLog</b>, then messages composed via these will not garble
each other.
<p>
The strategy employed is that the <b>ThreadSafeErrorLog</b> has its own 
area for building up a message, rather than using the common one in 
ELadministrator.  When the message is completed, the <b>ThreadSafeErrorLog</b>
will obtain a lock on the right to be sending a message to the administrator,
send the message, and release the lock.
<p>
An example of how this can be used is supplied in
<a href="../../Tests/MultiThreadTests/MultThread.h"> 
MultThread.h</a> and
<a href="../../Tests/MultiThreadTests/MultThread.cc"> 
MultThread.cc</a>.
Here, care is taken to set things up so that each thread has its own 
ThreadSafeErrorLog, known as <code>errlog</code>.  
Error messages are then issued in 
<em>exactly</em> the same way as they would have been through the normal
<code>errlog</code>, and the behavior is also the same except that there will
be no garbling of the output.

<a name="indexMutex"> </a>
<h3> The Mutex (Locking) Mechanism </h3>

Imagine a concept of the <em>right to issue a message to the 
administrator</em>.
We want to be "exception safe" -- which in this situation implies the 
ability to guarantee that whatever happens while that right has been acquired,
you always release the right before going away.
This is achieved by the idiom of "resource acquistion is object construction";
that is, a Mutex class is used to represent the right to issue a message.
When about to use the administrator, the ThreadSafeErrorLog opens a code block 
and instantiate a Mutex; at the end of the block the destructor is automaitcally 
called, which releases the lock.
<p>
Now the Exceptions package has no business dictating the actual locking 
mechanism to the user.  Instead, <b>ThreadSafeErrorLog</b> is templated
off an arbitrary user-defined class which we name <code>Mutex</code>.  
<p>
The <code>Mutex</code> class must have two properties:  
<ul>
<li> It must have a constructor taking no arguments,
which locks some lock, semaphore, or 
resource in whatever manner the user desires.
<li> It must have a destructor which releases that lock.
</ul>
A workable Mutex could be as simple as this (taken from the test
program <a href="../../Tests/MultiThreadTests/MultThread.cc"> 
MultThread.cc</a>):

<font color=blue>
<code>
<pre>
pthread_mutex_t* mutex;		// a posix mutex, represented as a global
				// scope pointer, initialized and set up
				// at some early point in the job.
struct Mutex {                                          
  Mutex() { pthread_mutex_lock(mutex);   }
 ~Mutex() { pthread_mutex_unlock(mutex); }
}
</pre>
</code>
</font>

<a name="indexerrlog"> </a>
<h2> Setting Up a <font color=blue>ThreadSafeErrorLog</font> 
	for Each Thread </h2>

This is the non-trivial point in using the ThreadSafeErrorLog.
Typically, errlog is established in one of two ways:
<ol>
<li> errlog might be a global variable of type ErrorLog
<li> errlog might be a data member of some Module class,
     and the various physics routines might be methods in that
     class (or a subclass of Module) -- those methods can use
     errlog as if it were a global
</ol>
The former method is unsuitable for using ThreadSafeErrorLog, 
since the one global variable would be shared (in a conflicting
manner) by all the threads, leading to the same garbling as 
observed with ErrorLog.
<p>
The latter method, having errlog as a public or protected 
ThreadSafeErrorLog data member in a Module class, works fine.
Each thread, upon startup, instantiates whatever Modules it requires,
and now each Module in each thread has its own ThreadSafeErrorLog which
can accumulate its own message independant of activities of other threads.
<p>
For example, code in the MultThread example does something like:
<font color=blue>
<code>
<pre>
class Module  {
public:
  Module( const std::string & name );
  virtual void operator()( Event & e ) = 0; // do this module's processing!
  virtual ~Module();
protected:
  ThreadSafeErrorLog<Mutex> errlog;                     
};  // Module

class DoPhysics : public Module {
public:
  DoPhysics( const std::string & name, int tnum ) : Module(name){}
  void operator()( Event & event ) {
  // ...
  errlog( ELsuccess, "An Event" ) << "data = " << event.data << endmsg;
  // ...
  }
};  // DoPhysics
</pre>
</code>
</font>

And each thread has its own Module because the thread program starts with:

<font color=blue>
<code>
<pre>
  DoPhysics  doPhysics( name );
</pre>
</code>
</font>

and causes the physics methods to be invoked via

<font color=blue>
<code>
<pre>
  for ( n = 1;  n < 20;  ++n )  {
    Event event( n );
    doPhysics( event );
  }
</pre>
</code>
</font>


<p><center>
<img src="http://www.fnal.gov/docs/working-groups/fpcltf/icons/bar.gif"></center>

<p><center>
<a href="0ErrorLogger.html"> Main ErrorLogger Package Page </a>
<p>
<a href="http://www.fnal.gov/docs/working-groups/fpcltf/fpcltf.html">
ZOOM Home Page </a> -

<a href="http://www.fnal.gov/faw/">Fermilab at Work</a> -

<a href="http://www.fnal.gov/">Fermilab Home</a>
</center>

<p>
      <hr>
      <address><a href="mailto:mf@fnal.gov">Mark Fischler</a></address>
<!-- hhmts start -->
Last modified: August 6, 1999
<!-- hhmts end -->
</body>
